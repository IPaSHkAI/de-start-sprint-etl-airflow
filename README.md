# Тренажер для спринта

Ниже приведена инструкция как запустить тренажер для спринта.
В состав тренажера входят:
- PostgreSQL
- Airflow

Airflow представлен в двух вариантах - с использованием CeleryExecutor и SequentialExecutor.
Мы рекомендуем использовать CeleryExecutor, так как он позволит посмотреть на то, из каких компонент состоит Airflow и, соответственно, получить более полное понимание работы Airflow. Однако, эта версия требует больше ресурсов - ей потребуется до 5GB RAM.

В качестве альтернативы вам представлена версия с использованием SequentialExecutor, которая потребует меньше ресурсов - около 1,5GB RAM. Если ресурсы системы не позволяют запустить CeleryExecutor, используйте SequentialExecutor. 

Выполнить все задания можно в обоих версиях Airflow.


Содержание:
- [Тренажер для спринта](#тренажер-для-спринта)
  - [Порты для postgres](#порты-для-postgres)
  - [1. Запуск Airflow с использованием CeleryExecutor](#1-запуск-airflow-с-использованием-celeryexecutor)
    - [1.1. Инициализация Airflow](#11-инициализация-airflow)
    - [1.2. Старт Airflow и VSC](#12-старт-airflow-и-vsc)
    - [1.3. Остановка и удаление контейнеров](#13-остановка-и-удаление-контейнеров)
  - [2. Запуск облегченной версии тренажера](#2-запуск-облегченной-версии-тренажера)
    - [2.1. Старт Airflow и VSC](#21-старт-airflow-и-vsc)
    - [2.2. Остановка и удаление контейнеров](#22-остановка-и-удаление-контейнеров)
  - [3. Координаты сервисов](#3-координаты-сервисов)

## Порты для postgres
В параметрах docker-compose.yaml и docker-compose-light.yaml указан порт 15432 для postgres, если у Вас этот порт занят то укажите другой, например 5434:

```yaml
  postgres:
    image: postgres:13
    ports:
      - 5434:5432
```

## 1. Запуск Airflow с использованием CeleryExecutor

### 1.1. Инициализация Airflow

Для настройки airflow выполните команду:

```bash
docker compose up airflow-init
```
Эту команду достаточно выполнить один раз.

### 1.2. Старт Airflow и VSC

Для запуска всех сервисов выполните (запускаем не только компоненты Airflow, но и Visual Studio Code для редактирования DAG-ов):

```bash
docker compose up -d airflow-webserver airflow-scheduler airflow-worker airflow-triggerer vsc
```
Имя файла конфигурации `docker-compose.yaml` не указывается, так как это значение по умолчанию.

Для запуска сервисов понадобится какое-то время. Полный старт может занять до 5 минут.

### 1.3. Остановка и удаление контейнеров

Для остановки тренажера выполните команду 
```bash
docker compose down
```

По окончании спринта остановите контейнеры и удалите образы с системы (будут удалены все сохраненные данные - БД, решения в заданиях и ДАГи): `docker compose down --volumes --rmi all`


## 2. Запуск облегченной версии тренажера

### 2.1. Старт Airflow и VSC

Для запуска облегченной версии тренажера выполните команду:

```bash
docker compose -f docker-compose-light.yaml up -d postgres airflow vsc
```

Команда отличается от версии выше только указанием файла конфигурации `docker-compose-light.yaml` и списком запускаемых сервисов.

Для запуска сервисов понадобится какое-то время. Полный старт может занять до 5 минут.

### 2.2. Остановка и удаление контейнеров

Для остановки тренажера выполните команду 
```bash
docker compose -f docker-compose-light.yaml down
```

По окончании спринта остановите контейнеры и удалите образы с системы (будут удалены все сохраненные данные - БД, решения в заданиях и ДАГи): `docker compose -f docker-compose-light.yaml down --volumes --rmi all`

## 3. Координаты сервисов

Тренажер (VSC) доступен по адресу [http://localhost:7090](http://localhost:7090), там же папка dags в которой вы разместите даги.

airflow по  [http://localhost:7004](http://localhost:7004),

База данных PostgreSQL:
Для подключения извне контейнера, например, с помощью DBeaver, используйте следующие настройки:
```json
"host": "localhost",
"port": 15432, # или укажите другой порт, если меняли в docker-compose
"database": "student",
"username": "student",
"password": "student-de"
```

Для подключения внутри контейнера (в тренажере, в DAGах) используйте следующие настройки:
```json
"host": "postgres",
"port": 5432,
"database": "student",
"username": "student",
"password": "student-de"
```